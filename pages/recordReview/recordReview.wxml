<!-- pages/recordReview/recordReview.wxml -->
<view class="container">
  <!-- é¡µé¢æ ‡é¢˜ -->
  <view class="header">
    <view class="header-content">
      <view class="title">å®¡æ ¸è®°å½•</view>
      <view class="subtitle" wx:if="{{assignment}}">{{assignment.petInfo.name}}</view>
    </view>
  </view>

  <!-- åŠ è½½ä¸­ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading">
      <view class="loading-icon"></view>
      <view class="loading-text">åŠ è½½ä¸­...</view>
    </view>
  </view>

  <!-- å®¡æ ¸å†…å®¹ -->
  <view class="review-container" wx:else>
    <!-- å® ç‰©ä¿¡æ¯ -->
    <view class="pet-info-card">
      <view class="pet-avatar">
        <image wx:if="{{assignment.petInfo.avatarUrl}}" src="{{assignment.petInfo.avatarUrl}}" mode="aspectFill"></image>
        <view wx:else class="default-avatar">ğŸˆ</view>
      </view>
      <view class="pet-details">
        <view class="pet-name">{{assignment.petInfo.name}}</view>
        <view class="pet-breed">{{assignment.petInfo.breed || 'æœªçŸ¥å“ç§'}}</view>
      </view>
      <view class="status-badge {{assignment.status}}">
        {{assignment.status === 'submitted' ? 'å¾…å®¡æ ¸' : 
          assignment.status === 'approved' ? 'å·²é€šè¿‡' : 
          assignment.status === 'rejected' ? 'å·²é€€å›' : 
          assignment.status === 'completed' ? 'å·²å®Œæˆ' : 'æœªçŸ¥çŠ¶æ€'}}
      </view>
    </view>

    <!-- åŒ»æŠ¤äººå‘˜ä¿¡æ¯ -->
    <view class="staff-info-card">
      <view class="card-title">åŒ»æŠ¤äººå‘˜</view>
      <view class="staff-info">
        <view class="staff-avatar">
          <image wx:if="{{assignment.staffInfo.avatarUrl}}" src="{{assignment.staffInfo.avatarUrl}}" mode="aspectFill"></image>
          <view wx:else class="default-avatar">ğŸ‘©â€âš•ï¸</view>
        </view>
        <view class="staff-details">
          <view class="staff-name">{{assignment.staffInfo.name || 'åŒ»æŠ¤äººå‘˜'}}</view>
          <view class="submit-time">æäº¤æ—¶é—´: {{assignment.updateTime ? (assignment.updateTime.toLocaleString ? assignment.updateTime.toLocaleString() : assignment.updateTime) : 'æœªçŸ¥'}}</view>
        </view>
      </view>
    </view>

    <!-- è®°å½•å†…å®¹ -->
    <view class="record-card">
      <view class="card-title">è®°å½•å†…å®¹</view>
      <view class="record-content">{{assignment.recordContent || 'æ— è®°å½•å†…å®¹'}}</view>
    </view>

    <!-- å›¾ç‰‡å±•ç¤º -->
    <view class="image-card" wx:if="{{assignment.fileIDs && assignment.fileIDs.length > 0}}">
      <view class="card-title">ä¸Šä¼ å›¾ç‰‡ ({{assignment.fileIDs.length}}å¼ )</view>
      <view class="image-grid">
        <view class="image-item" wx:for="{{assignment.fileIDs}}" wx:key="*this">
          <image class="preview-image" src="{{item}}" mode="aspectFill" bindtap="previewImage" data-src="{{item}}"></image>
        </view>
      </view>
    </view>

    <!-- å®¡æ ¸è¡¨å• -->
    <view class="review-form" wx:if="{{assignment.status === 'submitted'}}">
      <view class="form-card">
        <view class="card-title">å®¡æ ¸æ„è§</view>
        <view class="textarea-container">
          <textarea 
            class="comments-textarea" 
            placeholder="è¯·è¾“å…¥å®¡æ ¸æ„è§æˆ–é€€å›åŸå› ..." 
            maxlength="{{maxCommentLength}}" 
            bindinput="onInputComments"
            value="{{comments}}"
          ></textarea>
          <view class="character-count">{{commentCount}}/{{maxCommentLength}}</view>
        </view>
        <view class="tip-text">æç¤º: å¦‚æœé€‰æ‹©é€€å›ï¼Œè¯·å¡«å†™é€€å›åŸå› </view>
      </view>

      <!-- å®¡æ ¸æŒ‰é’® -->
      <view class="action-buttons">
        <button class="reject-btn" bindtap="reviewRecord" data-approved="{{false}}" disabled="{{submitting}}">
          {{submitting ? 'å¤„ç†ä¸­...' : 'é€€å›ä¿®æ”¹'}}
        </button>
        <button class="approve-btn" bindtap="reviewRecord" data-approved="{{true}}" disabled="{{submitting}}">
          {{submitting ? 'å¤„ç†ä¸­...' : 'é€šè¿‡å¹¶å‘å¸ƒ'}}
        </button>
      </view>
    </view>

    <!-- å†å²å®¡æ ¸è®°å½• -->
    <view class="history-card" wx:if="{{assignment.status !== 'submitted' && assignment.comments}}">
      <view class="card-title">å®¡æ ¸è®°å½•</view>
      <view class="history-content">
        <view class="history-status">
          çŠ¶æ€: 
          <text class="{{assignment.status === 'approved' || assignment.status === 'completed' ? 'approved-text' : 'rejected-text'}}">
            {{assignment.status === 'approved' || assignment.status === 'completed' ? 'å·²é€šè¿‡' : 'å·²é€€å›'}}
          </text>
        </view>
        <view class="history-time">å®¡æ ¸æ—¶é—´: {{assignment.approvalTime ? (assignment.approvalTime.toLocaleString ? assignment.approvalTime.toLocaleString() : assignment.approvalTime) : 'æœªçŸ¥'}}</view>
        <view class="history-comments" wx:if="{{assignment.comments}}">
          <view class="comments-title">å®¡æ ¸æ„è§:</view>
          <view class="comments-content">{{assignment.comments}}</view>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <view class="footer">
      <button class="back-btn" bindtap="goBack">è¿”å›</button>
      <button class="detail-btn" bindtap="viewPetDetail">æŸ¥çœ‹å® ç‰©è¯¦æƒ…</button>
    </view>
  </view>
</view>
